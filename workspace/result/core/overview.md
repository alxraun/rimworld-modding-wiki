## RimWorld Modding Documentation - Core Cheat Sheet

**Core Modding Fundamentals**: Mods are player-created modifications altering game functionality by adding, changing, or removing content like items, textures, mechanics. Types range from cosmetic (visual changes) to UI (quality of life) and game changes (new mechanics). Mods are acquired via Steam Workshop, Ludeon Forums, or third-party sites, installed in the `RimWorld/Mods/` directory, and activated in-game. Key modding approaches include XML `ThingDef` modifications for new things, C# code for new functionality linked via XML, and Harmony for code patching.

**Mod Folder Structure**: RimWorld mods reside in the `Mods/` directory within the game install. A mod folder requires an `About/About.xml` for identification (packageId, name, author, description, versions). Optional folders include `Assemblies/` for DLLs, `Defs/` for XML content, `Languages/` for localization, `Patches/` for XML modifications, `Sounds/`, and `Textures/`. Versioned folders (e.g., `1.4`, `Common`) and `LoadFolders.xml` allow for version-specific content loading.

**Application Startup Sequence**: RimWorld startup involves loading mod configurations, building mod lists (`ModLister.RebuildModList()`), initializing mods (`LoadedModManager.InitializeMods()`), loading assemblies and XML (`LoadedModManager.LoadModContent()`, `LoadModXML()`), applying patches (`LoadedModManager.ApplyPatches()`), resolving Def inheritance and cross-references (`XmlInheritance.TryRegister()`, `DirectXmlCrossRefLoader.ResolveAllWantedCrossReferences()`), loading language data (`LanguageDatabase.InitAllMetadata()`), storing Defs in `DefDatabase` and `DefOf` classes (`DefOfHelper.RebindAllDefOfs()`), and loading assets like audio and textures.

**About.xml**:  `About.xml` located in `Mods/YourMod/About/` is essential for mod identification, defining `<packageId>`, `<name>`, `<author>`, `<description>`, and `<supportedVersions>` within the root `<ModMetaData>` tag. Optional tags include `<modVersion>`, `<modIconPath>`, `<url>`, `<modDependencies>`, `<loadBefore>`, `<loadAfter>`, and `<incompatibleWith>` for versioning, dependencies, and load order management. `ModIcon.png` can be placed directly in the `About` folder for a mod icon.

**XML Def Fundamentals**: Defs are XML blueprints defining game elements in RimWorld, located in `Defs/` folders. XML structure starts with `<?xml version="1.0" encoding="utf-8"?>` and root `<Defs>` tag, containing `<DefType>` tags (e.g., `<ThingDef>`, `<RecipeDef>`). C# classes inheriting from `Def` define XML structure, with C# fields becoming XML tags. XML inheritance uses `Abstract="True"` for template Defs, `Name="DefName"` for parent Defs, and `ParentName="ParentDefName"` for child Defs, with `Inherit="False"` to stop inheritance. Custom Defs require `<DefType Class="MyNamespace.MyCustomDefClass">` in XML and `class MyCustomDefClass : DefType` in C#.

**XML Patching**: XML patching modifies existing Defs non-destructively using files in the `Patches/` folder. Basic structure includes root `<Patch>` tag and `<Operation Class="PatchOperationType">` tags. XPath syntax targets XML nodes (e.g., `Defs/ThingDef[defName="Wall"]/statBases`). Patch operations include `PatchOperationAdd`, `PatchOperationInsert`, `PatchOperationRemove`, `PatchOperationReplace`, `PatchOperationAttributeAdd/Set/Remove`, `PatchOperationSequence`, `PatchOperationAddModExtension`, `PatchOperationSetName`, `PatchOperationFindMod`, and `PatchOperationConditional`.

**Def Extensions**: Def modification methods range from overwriting (discouraged) to XPath patches (XML modifications), adding Comps/DefModExtensions (C# for functionality/data), subclassing Defs (C# for complex changes), custom Defs (C# for new types), tag checks, changing Def class, and Harmony patching (C# code modification). `DefModExtension` is a lightweight, compatible way to add data fields to Defs via XML, accessed in C# using `def.GetModExtension<YourModExtension>().fieldName`.

**ConfigErrors**: Implement `ConfigErrors()` method in custom Def classes to report XML configuration errors during startup. Override `ConfigErrors()` in Def subclasses, call `base.ConfigErrors()` to include base validations, and use `yield return "error message"` for each error condition. For custom classes without Def inheritance, implement `ConfigErrors()` and call nested class validations. Fallback validation uses `Log.Error("error message")` and manual validation methods.

**Def Compatibility**: Avoid overwriting Core or Mod Defs; use XPath patches instead. Reference `RecipeDef` via `<recipeUsers>`, `<recipes>`, `<recipeMaker><recipeUsers>`. Facilities link buildings using `CompAffectedByFacilities` and `CompFacility`. Animals are added to biomes via `<wildBiomes>` in `ThingDef`. Conditional loading uses `MayRequire="packageId1,packageId2"` and `MayRequireAnyOf="packageId1,packageId2"`. Defensive patching uses `PatchOperationFindMod` for mod compatibility.

**XML & C# Integration**: C# classes are used in XML via tags like `<workerClass>`, `<thingClass>`, and `Class` attributes. Custom C# types can be defined and serialized using `LoadDataFromXmlCustom`. C# accesses XML via `DefOf` classes (`[DefOf] static class MyDefOf { public static DefType DefName; }`) for fast access and `DefDatabase<DefType>.GetNamed("defName")` for direct lookup. Harmony is used for method modification, while `DefModExtension` and `ThingComp`/`HediffComp` add fields/behavior to Defs/Things/Hediffs.

**GrammarResolver**: `GrammarResolver` dynamically customizes text strings using symbols like `{KEY_subsymbol}` for objects (PAWN, FACTION, THING). Thing subsymbols include `{THING}`, `{THING_label}`, `{THING_definite}`, etc. Pawn subsymbols extend Thing subsymbols with `{PAWN_labelShort}`, `{PAWN_nameFull}`, `{PAWN_kind}`, etc. Faction subsymbols include `{FACTION}`, `{FACTION_name}`, `{FACTION_pawnSingular}`, etc. Resolver is invoked in C# using `.Formatted(object.Named("KEY"))` and `.AdjustedFor(pawn, "KEY")`.

**ThingDef Guide**: `ThingDef` defines properties of in-game "things." Tag meanings are learned via decompilation and code analysis. Example: `<intricate>` tag affects smelting products. Custom tags are added using `DefModExtension`. Decompile `Assembly-CSharp.dll`, search for tag names, and analyze code usage to understand tag functions.

**Component Pattern**: Comp pattern provides modular functionality for RimWorld objects. Component types include HediffComp, ThingComp, WorldObjectComp, MapComponent, WorldComponent, GameComponent, and StorytellerComp. Components are added to `ThingWithComps` and `HediffWithComps` via XML `<comps><li><CompClass/></comps>`. Key methods for override include `PostSpawnSetup`, `CompTick`, `CompTickRare`, `PostExposeData`, `CompGetGizmosExtra`. ThingComp vs. DefModExtension: ThingComp for instance-specific data and behavior, DefModExtension for global data. ThingComp vs. Harmony: ThingComp for adding functionality, Harmony for changing existing behavior.

**DebugActions**: `[DebugAction]` attribute on static methods makes them callable from the debug menu in Development Mode. Parameters include `Category`, `Button Label`, `actionType` (Action, ToolMap, ToolMapForPawns, ToolWorld), and `allowedGameStates`. Accessible via the cog button in the debug row.

**ExposeData**: `ExposeData()` method in classes like `Thing`, `ThingComp`, `HediffComp` handles saving. `Scribe` methods within `ExposeData()` save individual values. `Scribe_Values.Look` for simple types, `Scribe_Defs.Look` for Defs, `Scribe_Deep.Look`/`Scribe_References.Look` for Things, `Scribe_TargetInfo.Look` for TargetInfo, and `Scribe_Collections.Look` for collections.

**Game Components**: GameComponent, WorldComponent, and MapComponent add custom code at different levels. Implement constructors inheriting from base component classes. Access via `GetComponent<MyComponent>()` from `Current.Game`, `Find.World`, `Find.CurrentMap`. Overridable methods include `TYPEComponentUpdate`, `TYPEComponentTick`, `TYPEComponentOnGUI`, `ExposeData`, `FinalizeInit`, `StartedNewGame`, `LoadedGame`, `MapGenerated`, `MapRemoved`.

**Harmony Guide**: Harmony is a runtime patching library. Integrate by adding Harmony as a project reference (not including `0Harmony.dll` in Assemblies) and as a Steam dependency. Patch types: Prefix (before original), Postfix (after original), Transpiler (IL code modification). Modify results via `ref __result` in Postfix. Bootstrap Harmony in `[StaticConstructorOnStartup]` class using `Harmony.PatchAll()`.

**ModSettings**: `ModSettings` provide in-game customizable options. Requires `ModSettings` subclass for data and `Mod` subclass for GUI and saving. `ExposeData()` in `ModSettings` saves settings. `DoSettingsWindowContents(Rect inRect)` in `Mod` creates settings GUI using `Listing_Standard`. `SettingsCategory()` in `Mod` makes settings visible in the menu.

**RimWorld Classes Reference**: Useful RimWorld classes include Gen (GenDate, GenDraw, GenAdj, GenText), Utility (FoodUtility, RestUtility, PawnUtility), Maker (HediffMaker, ThingMaker), Tuning, Find (LetterStack, Archive, ResearchManager), PawnsFinder, Map (ListerBuildings, ListerThings), Pawn, Thing, DefDatabase, CellFinder, Command, Listing_Standard, Gizmo, BoolUnknown, LoadedModManager, Rand, LudeonTK (DebugActionAttribute). Decompile `Assembly-CSharp.dll` to explore game code.

**Transpiler Hints**: Debugging transpilers involves IL code inspection. Use code snippets to print modified IL code for debugging. Search GitHub for "Rimworld Harmony Transpiler" for examples. Debugging snippet uses `Log.Warning`/`Log.Message`/`Log.Error` to output IL code for analysis.

**TweakValue**: `[TweakValue]` attribute allows runtime value modification of static fields (`float`, `bool`, `int`, `ushort`) via Dev-Mode "TweakValues" window. Syntax: `[TweakValue("categoryName", minVal, maxVal)] private static dataType fieldName = defaultValue;`. Use `#if DEBUG` for debug builds only.

**Writing Custom Code**: Custom C# code extends RimWorld functionality. Create Class Library projects (.NET Framework 4.8), output to `Assemblies/`, reference `Assembly-CSharp.dll` and `UnityEngine.CoreModule.dll`. Use namespaces (RimWorld, Verse, UnityEngine, System.Collections.Generic, System.Linq). Link C# to XML via `<thingClass>`, `<compClass>`.

**Localization Guide**: Localization involves language files in `Mods/MyMod/Languages/[Language]/`. File types: DefInjected (translations for Def XML fields in `DefInjected/[DefType]/`), Keyed (translations for C# strings and UI in `Keyed/`), and Strings (word lists for RulePackDefs in `Strings/`). Keyed strings are accessed in C# using `"KeyString".Translate()`.

**Translation Guide**: Translation files are located in `Mods/MyMod/Languages/LanguageName/`. Types include DefInjected (`Languages/LanguageName/DefInjected/DefType/FileName.xml`), Keyed (`Languages/LanguageName/Keyed/AnyFileName.xml`), and Strings (`Languages/LanguageName/Strings/AnyFileName.xml`). Use prefixes for Keyed strings to ensure uniqueness.

**Testing Mods Guide**: Debug modes include Development Mode (accessed via Options) with Debug Log, Package Editor, View Settings, Debug Actions Menu, Inspector, God Mode, Pause on Error. Use debugger with Mono runtime. Debug Actions Menu -> Tools - Spawning/Incidents for testing specific content. Quickstart via `-quicktest` command line and `autostart.rws` savefile. Mod tools like HugsLib, Publisher Plus, TDBug, 4M Mehni's Misc Modifications aid testing.

**Troubleshooting - Finding Exceptions**: Troubleshooting exceptions involves using decompilers (ILSpy, dnSpy) to analyze stack traces. Read stack traces top-down, identify exception type (e.g., NullReferenceException), locate error source (Namespace.Class.MethodName), and decompile error source code to find null variable usage.

**Troubleshooting Guide**: Common XML errors include syntax, cross-reference, duplicate field, missing type, and referencing non-existing field errors. Solve XML errors sequentially, use XML validation, and check Player.log. Stacktraces are read top-down, identifying exception type and error source namespace. Bug reports should be detailed with logs and reproduction steps.

**XML Config Errors**: `ConfigErrors()` reports XML configuration issues. Implement in Def subclasses, call `base.ConfigErrors()`, and `yield return` error messages. For custom classes, implement `ConfigErrors()` and use `Log.Error()` for fallback validation.

**XML CSharp Integration**: XML uses C# classes via tags like `workerClass`, `thingClass`, and `Class` attribute. Custom types are serialized with `LoadDataFromXmlCustom`. C# accesses XML via `DefOf` and `DefDatabase`. Harmony modifies methods, `DefModExtension` adds Def fields, and `ThingComp`/`HediffComp` add Thing/Hediff behavior.

**XML ThingDef Guide**: `ThingDef` defines in-game "things." Tag meanings are learned via decompilation and code analysis. `DefModExtension` adds custom fields.

**XML Grammar Resolver Guide**: `GrammarResolver` customizes text strings dynamically using symbols like `{PAWN_labelShort}`. Invoke resolver in C# with `.Formatted()` and `.AdjustedFor()`.

**XML Patching Guide**: XML patching modifies Defs non-destructively. Use `PatchOperation` types like `Add`, `Insert`, `Remove`, `Replace`, `Attribute`, `Sequence`, `Conditional`, `FindMod`. XPath targets XML nodes.

**XML Def Compatibility Guide**: Def compatibility involves avoiding overwrites, using XPath patches, referencing Defs correctly (RecipeDef, Facilities, Animals), and conditional loading with `MayRequire`/`MayRequireAnyOf`. Defensive patching uses `PatchOperationFindMod`.
