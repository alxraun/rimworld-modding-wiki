## Документация по моддингу RimWorld - Основная шпаргалка

**Основы моддинга**: Моды - это созданные игроками модификации, изменяющие функциональность игры путем добавления, изменения или удаления контента, такого как предметы, текстуры, механики. Типы варьируются от косметических (визуальные изменения) до UI (качество жизни) и игровых изменений (новые механики). Моды приобретаются через Steam Workshop, Ludeon Forums или сторонние сайты, устанавливаются в директорию `RimWorld/Mods/` и активируются в игре. Ключевые подходы к моддингу включают XML-модификации `ThingDef` для новых вещей, код C# для новой функциональности, связанной через XML, и Harmony для патчинга кода.

**Структура папки мода**: Моды RimWorld находятся в директории `Mods/` внутри установки игры. Папка мода требует наличия `About/About.xml` для идентификации (packageId, name, author, description, versions). Дополнительные папки включают `Assemblies/` для DLL, `Defs/` для XML-контента, `Languages/` для локализации, `Patches/` для XML-модификаций, `Sounds/` и `Textures/`. Папки с версиями (например, `1.4`, `Common`) и `LoadFolders.xml` позволяют загружать контент, специфичный для версии.

**Последовательность запуска приложения**: Запуск RimWorld включает загрузку конфигураций модов, построение списков модов (`ModLister.RebuildModList()`), инициализацию модов (`LoadedModManager.InitializeMods()`), загрузку сборок и XML (`LoadedModManager.LoadModContent()`, `LoadModXML()`), применение патчей (`LoadedModManager.ApplyPatches()`), разрешение наследования Def и перекрестных ссылок (`XmlInheritance.TryRegister()`, `DirectXmlCrossRefLoader.ResolveAllWantedCrossReferences()`), загрузку языковых данных (`LanguageDatabase.InitAllMetadata()`), хранение Def в классах `DefDatabase` и `DefOf` (`DefOfHelper.RebindAllDefOfs()`) и загрузку ресурсов, таких как аудио и текстуры.

**About.xml**: `About.xml`, расположенный в `Mods/YourMod/About/`, необходим для идентификации мода, определяя `<packageId>`, `<name>`, `<author>`, `<description>` и `<supportedVersions>` внутри корневого тега `<ModMetaData>`. Дополнительные теги включают `<modVersion>`, `<modIconPath>`, `<url>`, `<modDependencies>`, `<loadBefore>`, `<loadAfter>` и `<incompatibleWith>` для версионирования, зависимостей и управления порядком загрузки. `ModIcon.png` можно разместить непосредственно в папке `About` для значка мода.

**Основы XML Def**: Def - это XML-чертежи, определяющие игровые элементы в RimWorld, расположенные в папках `Defs/`. XML-структура начинается с `<?xml version="1.0" encoding="utf-8"?>` и корневого тега `<Defs>`, содержащего теги `<DefType>` (например, `<ThingDef>`, `<RecipeDef>`). Классы C#, наследующие от `Def`, определяют XML-структуру, при этом поля C# становятся XML-тегами. XML-наследование использует `Abstract="True"` для шаблонных Def, `Name="DefName"` для родительских Def и `ParentName="ParentDefName"` для дочерних Def, с `Inherit="False"` для остановки наследования. Пользовательские Def требуют `<DefType Class="MyNamespace.MyCustomDefClass">` в XML и `class MyCustomDefClass : DefType` в C#.

**XML-патчинг**: XML-патчинг неразрушающе изменяет существующие Def с помощью файлов в папке `Patches/`. Базовая структура включает корневой тег `<Patch>` и теги `<Operation Class="PatchOperationType">`. Синтаксис XPath нацелен на XML-узлы (например, `Defs/ThingDef[defName="Wall"]/statBases`). Операции патчинга включают `PatchOperationAdd`, `PatchOperationInsert`, `PatchOperationRemove`, `PatchOperationReplace`, `PatchOperationAttributeAdd/Set/Remove`, `PatchOperationSequence`, `PatchOperationAddModExtension`, `PatchOperationSetName`, `PatchOperationFindMod` и `PatchOperationConditional`.

**Расширения Def**: Методы модификации Def варьируются от перезаписи (не рекомендуется) до XPath-патчей (XML-модификации), добавления Comps/DefModExtensions (C# для функциональности/данных), подклассов Def (C# для сложных изменений), пользовательских Def (C# для новых типов), проверок тегов, изменения класса Def и Harmony-патчинга (модификация кода C#). `DefModExtension` - это легкий, совместимый способ добавления полей данных к Def через XML, доступ к которым осуществляется в C# с помощью `def.GetModExtension<YourModExtension>().fieldName`.

**ConfigErrors**: Реализуйте метод `ConfigErrors()` в пользовательских классах Def, чтобы сообщать об ошибках конфигурации XML во время запуска. Переопределите `ConfigErrors()` в подклассах Def, вызовите `base.ConfigErrors()`, чтобы включить базовые проверки, и используйте `yield return "сообщение об ошибке"` для каждого условия ошибки. Для пользовательских классов без наследования Def реализуйте `ConfigErrors()` и вызовите проверки вложенных классов. Резервная проверка использует `Log.Error("сообщение об ошибке")` и методы ручной проверки.

**Совместимость Def**: Избегайте перезаписи Core или Mod Def; вместо этого используйте XPath-патчи. Ссылайтесь на `RecipeDef` через `<recipeUsers>`, `<recipes>`, `<recipeMaker><recipeUsers>`. Объекты связывают здания с помощью `CompAffectedByFacilities` и `CompFacility`. Животные добавляются в биомы через `<wildBiomes>` в `ThingDef`. Условная загрузка использует `MayRequire="packageId1,packageId2"` и `MayRequireAnyOf="packageId1,packageId2"`. Защитный патчинг использует `PatchOperationFindMod` для совместимости модов.

**Интеграция XML и C#**: Классы C# используются в XML через теги, такие как `<workerClass>`, `<thingClass>` и атрибуты `Class`. Пользовательские типы C# могут быть определены и сериализованы с помощью `LoadDataFromXmlCustom`. C# получает доступ к XML через классы `DefOf` (`[DefOf] static class MyDefOf { public static DefType DefName; }`) для быстрого доступа и `DefDatabase<DefType>.GetNamed("defName")` для прямого поиска. Harmony используется для модификации методов, в то время как `DefModExtension` и `ThingComp`/`HediffComp` добавляют поля/поведение к Def/Things/Hediffs.

**GrammarResolver**: `GrammarResolver` динамически настраивает текстовые строки, используя символы, такие как `{KEY_subsymbol}` для объектов (PAWN, FACTION, THING). Подсимволы Thing включают `{THING}`, `{THING_label}`, `{THING_definite}` и т. д. Подсимволы Pawn расширяют подсимволы Thing с помощью `{PAWN_labelShort}`, `{PAWN_nameFull}`, `{PAWN_kind}` и т. д. Подсимволы Faction включают `{FACTION}`, `{FACTION_name}`, `{FACTION_pawnSingular}` и т. д. Resolver вызывается в C# с помощью `.Formatted(object.Named("KEY"))` и `.AdjustedFor(pawn, "KEY")`.

**Руководство по ThingDef**: `ThingDef` определяет свойства игровых "вещей". Значения тегов изучаются путем декомпиляции и анализа кода. Пример: тег `<intricate>` влияет на продукты плавки. Пользовательские теги добавляются с помощью `DefModExtension`. Декомпилируйте `Assembly-CSharp.dll`, найдите имена тегов и проанализируйте использование кода, чтобы понять функции тегов.

**Паттерн компонентов**: Паттерн Comp обеспечивает модульную функциональность для объектов RimWorld. Типы компонентов включают HediffComp, ThingComp, WorldObjectComp, MapComponent, WorldComponent, GameComponent и StorytellerComp. Компоненты добавляются к `ThingWithComps` и `HediffWithComps` через XML `<comps><li><CompClass/></comps>`. Ключевые методы для переопределения включают `PostSpawnSetup`, `CompTick`, `CompTickRare`, `PostExposeData`, `CompGetGizmosExtra`. ThingComp vs. DefModExtension: ThingComp для данных и поведения, специфичных для экземпляра, DefModExtension для глобальных данных. ThingComp vs. Harmony: ThingComp для добавления функциональности, Harmony для изменения существующего поведения.

**DebugActions**: Атрибут `[DebugAction]` для статических методов делает их вызываемыми из меню отладки в режиме разработчика. Параметры включают `Category`, `Button Label`, `actionType` (Action, ToolMap, ToolMapForPawns, ToolWorld) и `allowedGameStates`. Доступно через кнопку шестеренки в строке отладки.

**ExposeData**: Метод `ExposeData()` в классах, таких как `Thing`, `ThingComp`, `HediffComp`, обрабатывает сохранение. Методы `Scribe` внутри `ExposeData()` сохраняют отдельные значения. `Scribe_Values.Look` для простых типов, `Scribe_Defs.Look` для Def, `Scribe_Deep.Look`/`Scribe_References.Look` для Things, `Scribe_TargetInfo.Look` для TargetInfo и `Scribe_Collections.Look` для коллекций.

**Игровые компоненты**: GameComponent, WorldComponent и MapComponent добавляют пользовательский код на разных уровнях. Реализуйте конструкторы, наследующие от базовых классов компонентов. Доступ через `GetComponent<MyComponent>()` из `Current.Game`, `Find.World`, `Find.CurrentMap`. Переопределяемые методы включают `TYPEComponentUpdate`, `TYPEComponentTick`, `TYPEComponentOnGUI`, `ExposeData`, `FinalizeInit`, `StartedNewGame`, `LoadedGame`, `MapGenerated`, `MapRemoved`.

**Руководство по Harmony**: Harmony - это библиотека патчинга во время выполнения. Интегрируйте, добавив Harmony в качестве ссылки на проект (не включая `0Harmony.dll` в Assemblies) и в качестве зависимости Steam. Типы патчей: Prefix (перед оригиналом), Postfix (после оригинала), Transpiler (модификация IL-кода). Изменяйте результаты через `ref __result` в Postfix. Загрузите Harmony в классе `[StaticConstructorOnStartup]`, используя `Harmony.PatchAll()`.

**ModSettings**: `ModSettings` предоставляют настраиваемые параметры в игре. Требуется подкласс `ModSettings` для данных и подкласс `Mod` для GUI и сохранения. `ExposeData()` в `ModSettings` сохраняет настройки. `DoSettingsWindowContents(Rect inRect)` в `Mod` создает GUI настроек, используя `Listing_Standard`. `SettingsCategory()` в `Mod` делает настройки видимыми в меню.

**Справочник по классам RimWorld**: Полезные классы RimWorld включают Gen (GenDate, GenDraw, GenAdj, GenText), Utility (FoodUtility, RestUtility, PawnUtility), Maker (HediffMaker, ThingMaker), Tuning, Find (LetterStack, Archive, ResearchManager), PawnsFinder, Map (ListerBuildings, ListerThings), Pawn, Thing, DefDatabase, CellFinder, Command, Listing_Standard, Gizmo, BoolUnknown, LoadedModManager, Rand, LudeonTK (DebugActionAttribute). Декомпилируйте `Assembly-CSharp.dll`, чтобы изучить игровой код.

**Советы по Transpiler**: Отладка transpiler включает проверку IL-кода. Используйте фрагменты кода для печати измененного IL-кода для отладки. Поищите "Rimworld Harmony Transpiler" на GitHub для примеров. Фрагмент отладки использует `Log.Warning`/`Log.Message`/`Log.Error` для вывода IL-кода для анализа.

**TweakValue**: Атрибут `[TweakValue]` позволяет изменять значения статических полей (`float`, `bool`, `int`, `ushort`) во время выполнения через окно Dev-Mode "TweakValues". Синтаксис: `[TweakValue("categoryName", minVal, maxVal)] private static dataType fieldName = defaultValue;`. Используйте `#if DEBUG` только для отладочных сборок.

**Написание пользовательского кода**: Пользовательский код C# расширяет функциональность RimWorld. Создайте проекты Class Library (.NET Framework 4.8), выведите в `Assemblies/`, сошлитесь на `Assembly-CSharp.dll` и `UnityEngine.CoreModule.dll`. Используйте пространства имен (RimWorld, Verse, UnityEngine, System.Collections.Generic, System.Linq). Свяжите C# с XML через `<thingClass>`, `<compClass>`.

**Руководство по локализации**: Локализация включает языковые файлы в `Mods/MyMod/Languages/[Language]/`. Типы файлов: DefInjected (переводы для полей Def XML в `DefInjected/[DefType]/`), Keyed (переводы для строк C# и UI в `Keyed/`) и Strings (списки слов для RulePackDefs в `Strings/`). Строки Keyed доступны в C# с помощью `"KeyString".Translate()`.

**Руководство по переводу**: Файлы перевода расположены в `Mods/MyMod/Languages/LanguageName/`. Типы включают DefInjected (`Languages/LanguageName/DefInjected/DefType/FileName.xml`), Keyed (`Languages/LanguageName/Keyed/AnyFileName.xml`) и Strings (`Languages/LanguageName/Strings/AnyFileName.xml`). Используйте префиксы для строк Keyed, чтобы обеспечить уникальность.

**Руководство по тестированию модов**: Режимы отладки включают режим разработчика (доступен через Options) с Debug Log, Package Editor, View Settings, Debug Actions Menu, Inspector, God Mode, Pause on Error. Используйте отладчик с Mono runtime. Debug Actions Menu -> Tools - Spawning/Incidents для тестирования конкретного контента. Быстрый запуск через командную строку `-quicktest` и файл сохранения `autostart.rws`. Инструменты для модов, такие как HugsLib, Publisher Plus, TDBug, 4M Mehni's Misc Modifications, помогают в тестировании.

**Устранение неполадок - Поиск исключений**: Устранение неполадок с исключениями включает использование декомпиляторов (ILSpy, dnSpy) для анализа трассировок стека. Читайте трассировки стека сверху вниз, определите тип исключения (например, NullReferenceException), найдите источник ошибки (Namespace.Class.MethodName) и декомпилируйте исходный код ошибки, чтобы найти использование нулевой переменной.

**Руководство по устранению неполадок**: Распространенные ошибки XML включают синтаксические ошибки, перекрестные ссылки, дублирование полей, отсутствие типа и ссылки на несуществующие поля. Устраняйте ошибки XML последовательно, используйте проверку XML и проверьте Player.log. Трассировки стека читаются сверху вниз, определяя тип исключения и пространство имен источника ошибки. Отчеты об ошибках должны быть подробными, с журналами и шагами воспроизведения.

**Ошибки конфигурации XML**: `ConfigErrors()` сообщает об ошибках конфигурации XML. Реализуйте в подклассах Def, вызовите `base.ConfigErrors()` и `yield return` сообщения об ошибках. Для пользовательских классов реализуйте `ConfigErrors()` и используйте `Log.Error()` для резервной проверки.

**Интеграция XML CSharp**: XML использует классы C# через теги, такие как `workerClass`, `thingClass` и атрибут `Class`. Пользовательские типы сериализуются с помощью `LoadDataFromXmlCustom`. C# получает доступ к XML через `DefOf` и `DefDatabase`. Harmony модифицирует методы, `DefModExtension` добавляет поля Def, а `ThingComp`/`HediffComp` добавляют поведение Thing/Hediff.

**Руководство по XML ThingDef**: `ThingDef` определяет игровые "вещи". Значения тегов изучаются путем декомпиляции и анализа кода. `DefModExtension` добавляет пользовательские поля.

**Руководство по XML Grammar Resolver**: `GrammarResolver` динамически настраивает текстовые строки, используя символы, такие как `{PAWN_labelShort}`. Вызовите resolver в C# с помощью `.Formatted()` и `.AdjustedFor()`.

**Руководство по XML Patching**: XML-патчинг неразрушающе изменяет Def. Используйте типы `PatchOperation`, такие как `Add`, `Insert`, `Remove`, `Replace`, `Attribute`, `Sequence`, `Conditional`, `FindMod`. XPath нацелен на XML-узлы.

**Руководство по совместимости XML Def**: Совместимость Def включает избежание перезаписей, использование XPath-патчей, правильную ссылку на Def (RecipeDef, Facilities, Animals) и условную загрузку с помощью `MayRequire`/`MayRequireAnyOf`. Защитный патчинг использует `PatchOperationFindMod`.
